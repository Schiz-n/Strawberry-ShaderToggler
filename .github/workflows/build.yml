name: Build and Auto-Release ShaderToggler

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Generate timestamp
      id: timestamp
      shell: pwsh
      run: |
        $date = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
        echo "value=$date" >> $env:GITHUB_OUTPUT

    - name: Build x64
      run: |
        msbuild src/ShaderToggler.sln `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:OutDir=..\artifacts\x64\ `
          /m

    - name: Build x86
      run: |
        msbuild src/ShaderToggler.sln `
          /p:Configuration=Release `
          /p:Platform=x86 `
          /p:OutDir=..\artifacts\x86\ `
          /m

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.timestamp.outputs.value }}
        name: Build ${{ steps.timestamp.outputs.value }}
        files: |
          artifacts/x64/ShaderToggler.addon64
          artifacts/x86/ShaderToggler.addon
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
